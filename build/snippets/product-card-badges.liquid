{%- doc -%}
  Renders product badges for the product card.

  @param {object} product - The product object.
  @param {object} settings - The theme settings object.

  @example
  {% render 'product-card-badges', product: product, settings: settings %}
{%- enddoc -%}

{%- liquid
  assign target_variant = product.selected_or_first_available_variant

  assign show_savings = settings.badge_show_savings | default: false
  assign savings_display_type = settings.badge_savings_display_type | default: 'percent'
  assign badge_position = settings.badge_position | default: 'top-left'
  assign badge_corner_radius = settings.badge_corner_radius | default: 40
  assign badge_sale_color_scheme = settings.badge_sale_color_scheme | default: 'scheme-4'
  assign badge_sold_out_color_scheme = settings.badge_sold_out_color_scheme | default: 'scheme-5'
  assign badge_font_family = settings.badge_font_family | default: 'body'
  assign badge_text_transform = settings.badge_text_transform | default: 'none'
  assign badge_enable_animation = settings.badge_enable_animation | default: false, allow_false: true

  assign badge_text_regular = settings.badge_text | default: '' | strip
  assign badge_text_savings = settings.badge_text_savings | default: '' | strip

  assign has_savings = false
  assign savings_token_value = ''

  if target_variant.compare_at_price > target_variant.price
    assign has_savings = true

    assign savings_value = target_variant.compare_at_price | minus: target_variant.price
    assign savings_value_formatted = savings_value | money

    if savings_display_type == 'percent'
      assign savings_percent = savings_value | times: 100.0 | divided_by: target_variant.compare_at_price | round
      assign savings_token_value = savings_percent | append: '%'
    else
      assign savings_token_value = savings_value_formatted
    endif
  endif
-%}

{%- if target_variant.available == false or has_savings -%}

  <product-badges
    data-product-id="{{ product.id }}"
    data-product-url="{{ product.url }}"
    class="
      product-badges
      product-badges--{{ badge_position }}
      {% if badge_enable_animation %}
        product-badges--animations-enabled
      {% endif %}
    "
    style="
      --badge-border-radius: {{ badge_corner_radius }}px;
      --badge-font-family: var(--font-{{ badge_font_family }}--family);
      --badge-font-weight: var(--font-{{ badge_font_family }}--weight);
      --badge-text-transform: {{ badge_text_transform }};
    "
  >
    <div
      class="
        product-badges__badge
        product-badges__badge--rectangle
        {% if target_variant.available == false %}
          color-{{ badge_sold_out_color_scheme }}
        {% else %}
          color-{{ badge_sale_color_scheme }}
        {% endif %}
      "
    >
      {%- if target_variant.available == false -%}

        {{ 'content.product_badge_sold_out' | t }}

      {%- elsif has_savings -%}

        {%- if show_savings -%}

          {%- if badge_text_savings != blank -%}
            {{ badge_text_savings | replace: '%value%', savings_token_value }}
          {%- else -%}
            {{ 'content.badge_text_save_dynamic' | t: value: savings_token_value }}
          {%- endif -%}

        {%- else -%}

          {%- if badge_text_regular != blank -%}
            {{ badge_text_regular }}
          {%- else -%}
            {{ 'content.product_badge_sale' | t }}
          {%- endif -%}

        {%- endif -%}

      {%- endif -%}
    </div>
  </product-badges>

{%- endif -%}

{% stylesheet %}
  .product-badges {
    --badge-inset: max(var(--padding-xs), calc((var(--border-radius) + var(--padding-xs)) * (1 - cos(45deg))));
    display: block;
    position: absolute;
    z-index: var(--layer-flat);
  }

  .product-badges--top-left {
    top: calc(var(--badge-inset) + var(--padding-block-start));
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-right {
    top: calc(var(--badge-inset) + var(--padding-block-start));
    right: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--bottom-left {
    bottom: calc(var(--badge-inset) + var(--padding-block-start));
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--bottom-right {
    bottom: calc(var(--badge-inset) + var(--padding-block-start));
    right: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges__badge {
    --badge-font-size: var(--font-size--xs);

    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--color-foreground);
    background: var(--color-background);
    font-size: var(--badge-font-size);
    font-family: var(--badge-font-family);
    font-weight: var(--badge-font-weight);
    text-transform: var(--badge-text-transform);
    border-radius: var(--badge-border-radius);
  }

  .product-badges__badge--rectangle {
    padding-block: var(--badge-rectangle-padding-block);
    padding-inline: var(--badge-rectangle-padding-inline);
  }

  .product-badges.badge-animate .product-badges__badge {
    animation: badgeFadeIn var(--animation-speed-medium) var(--animation-timing-fade-in);
  }

  .product-badges:not(.product-badges--animations-enabled) .product-badges__badge {
    animation: none !important;
  }

  @keyframes badgeFadeIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .product-badges.badge-fade-out .product-badges__badge {
    animation: badgeFadeOut var(--animation-speed) var(--animation-timing-fade-out) forwards;
  }

  @keyframes badgeFadeOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(4px);
    }
  }
{% endstylesheet %}
